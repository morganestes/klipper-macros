[gcode_macro level_bed]
gcode:
    {% set PROFILE_NAME = params.PROFILE_NAME|default('meshy') %}

    SAVE_GCODE_STATE NAME={PROFILE_NAME}_mesh
    SAVE_AT_END

    HOME

    BED_MESH_CLEAR
    BED_MESH_CALIBRATE PROFILE={PROFILE_NAME} METHOD=automatic
    BED_MESH_PROFILE SAVE={PROFILE_NAME}
    BED_MESH_PROFILE LOAD={PROFILE_NAME}

    BEEP BEEPS=3
    HOME

    RESTORE_GCODE_STATE NAME={PROFILE_NAME}_mesh
    SAVE_IF_SET
